<!DOCTYPE html>
<html lang="en">
<head>
	<title>CSC73010 Part1 dhogan15</title>
 	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" href="custom.css" />
	<script src="http://code.jquery.com/jquery-1.12.0.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

	<script>
        var url = "http://spike.scu.edu.au/~barry/CSC73010/contacts.html";
        var contactDetails = [];
        var selectedContact = 1;

        $(document).ready(function() {
            $("#dataHolder").hide();
            $("#dataHolder").load(url+"#myData", function (resp, status, xhr) {
                if (status=="error") { // data loading error
                    alert("There was an error loading the data: " + xhr.statusText);
                }
                else if (status=="success") {

                    // get table row data and put into items list/object
                    // skip first row with table headers
                    contactDetails = $('#myData tr:not(:first-child)').map(function () {
                        var children = $(this).children();

                        return {
                           surname: children.eq(0).text(),
                           othernames: children.eq(1).text(),
                           company: children.eq(2).text(),
                           email: children.eq(3).text(),
                           phone1: children.eq(4).text(),
                           phone2: children.eq(5).text(),
                           snailmail: children.eq(6).text()
                        };
                    }).get();

                    // put data into body data attribute
                    $("body").data("contact-details", contactDetails);
                }
            });

            // testing out using .data function !!!!!!!!!
            $("#footer").click(function(){
                // print array data from body data attribute
                alert(JSON.stringify( $("body").data("contact-details")) );
            });

            // update contact data from edit contact page (form)
            $( "#contactform" ).submit(function( event ) {
                alert( "Handler for contact form called." ); // testing!!!

                // put form data into array
                var detail = $(this).serializeArray();

                // update local data with updated contact details
                contactDetails[selectedContact] = updateContact(detail);





                sessionStorage.setObj("contacts", contactDetails);
                




                // load contact list page
                $( "#contactList" ).pagecontainer( "change" );
                event.preventDefault();
            });

            // returns key value array for contact data
            function updateContact (d) {
                var arr = {};
                $(d).each(function() {
                    var n = $(this).attr("name"); // field name
                    var v = $(this).attr("value"); // contact data
                    if (v == null) {
                        v = ""; // avoids undefined when empty field
                    }
                    arr[n] = v;
                });
                return arr;
            };

            // extend localstorage to hold objects
            Storage.prototype.setObj = function(key, obj) {
                return this.setItem(key, JSON.stringify(obj))
            }
            Storage.prototype.getObj = function(key) {
                return JSON.parse(this.getItem(key))
            }

        });

        // prepare contact list page
        $(document).on("pagebeforeshow","#contactList", function() {
            $("#clist").empty();
            
            // sort arrays in array
            contactDetails.sort(function (a, b){
                var aSurname = a.surname.toLowerCase();
                var bSurname = b.surname.toLowerCase();
                // compare & sort each arrays surname alphabetically (shorthand)
                return ((aSurname < bSurname) ? -1 : ((aSurname > bSurname) ? 1 : 0));
            });

            for (var i=0; i<contactDetails.length; i++){  
                
                // add list html to elements
                $("#clist").append("<li><a href='#edit' id='list"+i+"'>" + contactDetails[i].surname+", "+contactDetails[i].othernames+"<a></li>");
            }

            $("#clist").listview("refresh"); // refresh jquery mobile list
            
            // have to insert event handler after list refreshed!!!!
            // because html element not there yet
            for (var i=0; i<contactDetails.length; i++){  
                
                // add list html to elements
                $("#list"+i).on("tap", i, function (evt) { 
                    selectedContact=evt.data; // value extracted by evt.data 
                });
            }
        });

        // prepare edit contact page
        $(document).on("pagebeforeshow","#edit", function() {
            $("#surname").val(contactDetails[selectedContact].surname);
            $("#othernames").val(contactDetails[selectedContact].othernames);
            $("#company").val(contactDetails[selectedContact].company);
            $("#email").val(contactDetails[selectedContact].email);
            $("#phone1").val(contactDetails[selectedContact].phone1);
            $("#phone2").val(contactDetails[selectedContact].phone2);
            $("#snailmail").val(contactDetails[selectedContact].snailmail);
        });

	</script>

</head>
<body data-contact-details="">
    <div id="dataHolder"></div>

    <!-- MAIN PAGE -->
	<div data-role="page" id="main">
		<div data-role="header">
			<h1>Contact Information for Units</h1>
		</div>
		<div data-role="main" class="ui-content">
            <div id="pageData"></div>
            <a href="#contactList" class="ui-btn">List contacts</a>
		</div>
		<div data-role="footer" id="footer">
			<h1>Footer Text</h1>
		</div>
	</div>

    <!-- VIEW CONTACTS PAGE -->
    <div data-role="page" id="contactList">
      <div data-role="header">
        <h1>Contact List</h1>
      </div>
      <div data-role="main">
          <ul data-role="listview" data-inset="true" id="clist" data-autodividers="true">
          </ul>
      </div>
    </div>

    <!-- EDIT CONTACTS PAGE -->
    <div data-role="page" id="edit">
        <div data-role="header">
            <h1>Edit Contact</h1>
        </div>
        <div data-role="main">
            <form method="post" action="" id="contactform">
                <label for="surname">Surname:</label>
                <input type="text" id="surname" name="surname"></input>
                <label for="othernames">Other Names:</label>
                <input type="text" id="othernames" name="othernames"></input>
                <label for="company">Company:</label>
                <input type="text" id="company" name="company"></input>
                <label for="email">Email:</label>
                <input type="text" id="email" name="email"></input>
                <label for="phone1">Phone 1:</label>
                <input type="text" id="phone1" name="phone1"></input>
                <label for="phone2">Phone 2:</label>
                <input type="text" id="phone2" name="phone2"></input>
                <label for="snailmail">Snail Mail:</label>
                <input type="text" id="snailmail" name="snailmail"></input>
                <input type="submit" value="Update">
            </form>
        </div>
    </div>
</body>
</html>